<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script type="text/javascript">
$( document ).ready( function( e )
{
    // Source: http://complexdan.com/svg-circleellipse-to-path-converter/
    var circle_to_path = function( cx, cy, r )
    {
		var output = "M" + ( cx - r ).toString() + "," + cy.toString();

		output += "a" + r.toString() + "," + r.toString() + " 0 1,0 " + ( 2 * r ).toString() + ",0";
		output += "a" + r.toString() + "," + r.toString() + " 0 1,0 " + ( -2 * r ).toString() + ",0";
		
        return output;
    };

    var render_label = function()
    {
        // Fetch params from the form
        
        // Big (bottom) radius of the base, in mm.
        let bigRadius = parseFloat( $( '#base-big-diameter' ).val() ) / 2;

        // Small (top) radius of the base, in mm.        
        let smallRadius = parseFloat( $( '#base-small-diameter' ).val() ) / 2;

        // Height of the base, in mm.        
        let height = parseFloat( $( '#base-height' ).val() );

        let text = $( '#text' ).val();
        let kerning = parseFloat( $( '#kerning' ).val() );
        let padding = parseFloat( $( '#padding' ).val() ); 

        let backgroundColor = $( '#bg-color' ).val();
        let foregroundColor = $( '#fg-color' ).val();

        // Formula comes from http://mathforum.org/dr.math/faq/formulas/BuildFrustum.html
        let t = Math.atan( ( bigRadius / smallRadius ) / height );
        let sint = ( bigRadius - smallRadius ) / Math.sqrt (Math.pow( height, 2 ) + Math.pow( ( bigRadius - smallRadius ), 2 ) );
        let innerRingRadius = bigRadius / sint;

        // Thickness of the label, in mm.
        let thickness = innerRingRadius - smallRadius / sint;

        // Middle of the arc circle, in mm
        let centerRingRadius = innerRingRadius + thickness / 2;

        // Outer edge of the arc circle, in mm.        
        let outerRingRadius = centerRingRadius + thickness / 2;

        let innerCircumference = 2 * 3.141592635 * innerRingRadius;
        let centerCircumference = 2 * 3.141592635 * centerRingRadius;
        let outerCircumference = 2 * 3.141592635 * outerRingRadius;

        // Why this weird constant? Dunno!!!
        let weirdConstant = 3.64;

        // The total usage of the circumference should add the text length and two time the padding for left and right.
        let centerDashFill = ( kerning + ( padding * 2 ) ) * weirdConstant;
        let centerDashUnfill = centerCircumference - centerDashFill;

        // Ratio is an angle where 1 means full circle.
        let ratio = centerDashFill / centerCircumference;

        // Arc circle angle, in radians.
        let angle = ratio * 2 * 3.141592635;

        let innerDashFill = ratio * innerCircumference;
        let innerDashUnfill = innerCircumference - innerDashFill;

        let outerDashFill = ratio * outerCircumference;
        let outerDashUnfill = outerCircumference - outerDashFill;

        // As the ring has a thickness, we need to evaluate the outer and the inner ring to get the most width
        let innerCanvasWidth = ( 1 - Math.cos( angle ) ) * innerRingRadius + thickness;
        let outerCanvasWidth = ( 1 - Math.cos( angle ) ) * outerRingRadius;

        let weirdScaleFactorAgain = 0.94;

        let canvasWidth = Math.max( innerCanvasWidth, outerCanvasWidth ) * weirdScaleFactorAgain;

        console.log( 'inner ' + innerCanvasWidth + ' outer ' + outerCanvasWidth + ' width ' + canvasWidth );

        let viewPortWidth = canvasWidth;
        let viewPortHeight = outerRingRadius;

        let viewBoxProperty = '0 0 ' + viewPortWidth + ' ' + viewPortHeight; 

        let x_offset = -outerRingRadius;

        // Sets the size of the label to print, in mm.
        // $( '#label' ).attr( 'width', viewPortWidth );
        // $( '#label' ).attr( 'height', viewPortHeight );
        $( '#label' ).css( 'width', viewPortWidth + 'mm' );
        $( '#label' ).css( 'height', viewPortHeight + 'mm' );    

        // Sets the view box property to the size of the label, in mm.
        // $( '#label' ).attr( 'viewBox', viewBoxProperty );

        let contents = '';

        // Scale from https://stackoverflow.com/questions/30806126/drawing-svg-path-and-polygon-in-cm
        contents += '<g transform="scale(3.543307)">';
        contents += '   <circle cx="' + x_offset + '" cy="0" r="' + centerRingRadius + '" stroke-dasharray="' + centerDashFill + ' ' + centerDashUnfill + '" stroke="' + backgroundColor + '" stroke-width="' + thickness + '" fill="none" transform="scale(-1,1)" />';

        if( false )
        {
            contents += '   <line x1="-1000" x2="1000" y1="0" y2="0" stroke-width="0.25" stroke="red" fill="none" />';
            contents += '   <line x1="0" x2="0" y1="-1000" y2="1000" stroke-width="0.25" stroke="green" fill="none" />';        
            contents += '   <circle cx="' + x_offset + '" cy="0" r="' + innerRingRadius + '" stroke-dasharray="' + innerDashFill + ' ' + innerDashUnfill + '" stroke="red" stroke-width="0.25" fill="none" transform="scale(-1,1)" />';                
            contents += '   <circle cx="' + x_offset + '" cy="0" r="' + outerRingRadius + '" stroke-dasharray="' + outerDashFill + ' ' + outerDashUnfill + '" stroke="red" stroke-width="0.25" fill="none" transform="scale(-1,1)" />';        
            contents += '   <path id="curve" d="' + circle_to_path( -x_offset, 0, outerRingRadius - ( thickness / 8 ) ) + '" stroke="white" stroke-width="0.25" fill="none"></path>';            
            contents += '   <line x1="' + innerCanvasWidth + '" x2="' + innerCanvasWidth + '" y1="-1000" y2="+1000" stroke-width="0.25" stroke="grey" fill="none" />';            
            contents += '   <line x1="' + outerCanvasWidth + '" x2="' + outerCanvasWidth + '" y1="-1000" y2="+1000" stroke-width="0.25" stroke="grey" fill="none" />';                                                            
        }
        else
        {
            contents += '   <path id="curve" d="' + circle_to_path( -x_offset, 0, outerRingRadius - ( thickness / 8 ) ) + '" fill="none"></path>';            
        }

        contents += '   <text textLength="' + kerning + 'mm" fill="' + foregroundColor + '" style="font-family: impact; font-size: ' + ( thickness / 4 ) + 'mm;">';
        contents += '       <textPath xlink:href="#curve" startOffset="' + padding + 'mm">' + text + '</textPath>';
        contents += '   </text>';
        contents += '</g>';

        document.getElementById( 'label' ).innerHTML = contents;
    };

    $( '#text, #base-small-diameter, #base-height, #base-big-diameter' ).on( 'change keyup blur', function( e )
    {
        render_label();
    });

    // Hook when changing the kerning, update the label.
    $( '#kerning, #padding' ).on( 'mousedown mousemove change', function( e )
    {
        render_label();
    });

    // Hook when changing the color, update the label.
    $( '#fg-color, #bg-color' ).on( 'change', function( e )
    {
        render_label();
    });

    // Upon init, render the first label
    render_label();
});        
        </script>
        <style>
@media screen
{
    body
    {
        background-color: lightgrey;
    }        

    svg
    {
        /* background-clip: content-box; */
        background-color: white;
        /* border: 1px solid black; */
        box-sizing: content-box;
        /* padding: 5px; */
        /* transform: scale(1); */
    }
}

@media print
{
    h1,
    form
    {
        display: none;
    }

    svg
    {
        padding: 1cm;
    }
}
        </style>
    </head>
    <body>
        <h1>Base label generator</h1>
        <svg id="label"></svg>
        <form id="controls">
            <h2>Base parameters</h2>
            <div>
                <input type="text" id="base-big-diameter" name="base_big_diameter" value="25.4" placeholder="25.4"/>
                <label for="text">Base's big diameter (top), in mm.</label>
            </div>                                     
            <div>
                <input type="text" id="base-small-diameter" name="base_small_diameter" value="23.0" placeholder="23"/>
                <label for="text">Base's small diameter (bottom), in mm.</label>
            </div>  
            <div>
                <input type="text" id="base-height" name="base_height" value="3.2" placeholder="3.2"/>
                <label for="text">Base's height, in mm.</label>
            </div>
            <h2>Text parameters</h2> 
            <div>
                <input type="color" id="bg-color" name="bg_color" value="#000000" />
                <label for="bg-color">Background color</label>
            </div>    
            <div>
                    <input type="color" id="fg-color" name="fg_color" value="#ffffff" />
                    <label for="bg-color">Foreground color</label>
                </div>                                                           
            <div>
                <input type="text" id="text" name="name" placeholder="Type the unit name here"/>
                <label for="text">Text</label>
            </div>               
            <div>
                    <input type="range" id="padding" name="volume" min="0" max="5" step="0.05" />
                    <label for="padding">Padding</label>
                </div>               
            <div>
                <input type="range" id="kerning" name="volume" min="5" max="20" step="0.1" />
                <label for="kerning">Kerning</label>
            </div>           
        </form>
    </body>
</html>